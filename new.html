<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NutriFind – Recipe Nutrition Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tailwind configuration for custom colors/font */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        :root {
            --primary: #0a7c36;
            --secondary: #f4f7f8;
            --accent: #222;
        }
        body { font-family: 'Inter', sans-serif; background: var(--secondary); }
        .calc-btn, .add-btn { transition: background-color 0.2s; }

        /* Custom Nutrition Label Styling */
        .nutrition-label {
            width: 100%;
            border: 2px solid var(--accent);
            padding: 5px 15px;
            margin-top: 20px;
            background: white;
        }
        .label-header { 
            font-size: 28px; 
            font-weight: 900; 
            margin: 5px 0 0;
            padding-bottom: 5px;
            border-bottom: 10px solid var(--accent); 
        }
        .line { padding: 4px 0; border-bottom: 1px solid var(--accent); overflow: hidden; font-size: 14px; }
        .line span { float: right; font-weight: bold; }
        .line.thick { border-bottom-width: 3px; }
        .line.no-border { border-bottom: none; }
        .line.indent { margin-left: 15px; }
        
        /* Custom Styles for Buttons */
        .copy-btn { background-color: var(--accent); }
        .copy-btn:hover { background-color: #555; }
        .calc-btn, .share-btn, .add-btn { background-color: var(--primary); }
        .calc-btn:hover, .share-btn:hover, .add-btn:hover { background-color: #08662a; }

    </style>
</head>
<body class="min-h-screen flex flex-col items-center">
    <header class="text-center p-6 bg-white w-full shadow-md">
        <h1 class="text-3xl font-extrabold text-gray-800">NutriFind Recipe Calculator</h1>
        <p class="text-sm text-gray-500 mt-1">Analyze the nutrition of your recipes using natural language.</p>
    </header>
    
    <div class="container p-4 w-full max-w-2xl">
        
        <!-- Ingredient Input Card -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-6 border border-gray-100">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Recipe Ingredients</h2>
            <div id="ingredientsContainer"></div>
            
            <div class="flex flex-wrap gap-3 mt-4">
                <button class="add-btn flex-grow md:flex-grow-0 py-2 px-4 text-sm font-medium rounded-lg" onclick="addIngredient()">+ Add Ingredient</button>
                <button class="calc-btn flex-grow py-2 px-4 text-lg font-bold rounded-lg" onclick="calculateRecipe()">Calculate Nutrition</button>
            </div>
        </div>

        <!-- Results Card -->
        <div id="resultsCard" class="bg-white p-6 rounded-xl shadow-lg border border-gray-100" style="display:none;">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">Results Summary</h2>

            <!-- Nutrition Label Table -->
            <div class="nutrition-label">
                <h3 class="label-header">Nutrition Facts</h3>
                <div id="nutritionTable"></div>
            </div>

            <!-- Macro Chart -->
            <div class="mt-8">
                <h3 class="text-lg font-semibold mb-3 text-gray-700">Macronutrient Breakdown (by weight)</h3>
                <canvas id="macroChart" class="rounded-lg border p-4"></canvas>
            </div>

            <div class="share-buttons flex gap-3 mt-4">
                <button class="copy-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="copyTable()">Copy Nutrition Table</button>
                <button class="share-btn flex-grow py-2 px-4 font-medium rounded-lg text-sm" onclick="shareTable()">Share Results</button>
            </div>
        </div>
    </div>
    
    <footer class="sticky bottom-0 bg-white p-4 w-full text-center text-xs text-gray-500 border-t border-gray-200 mt-auto">
        NutriFind © 2025 · Powered by CalorieNinjas API.
        <br>
        <span class="text-red-500">Note: This calculator requires a Vercel/Node.js backend for the `/api/nutrition` endpoint to function.</span>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script>
        // Set up the initial ingredient row on load
        document.addEventListener('DOMContentLoaded', () => {
            addIngredient();
        });

        function ingredientRowHTML() {
            return `
            <div class="ingredient-row flex gap-2 mb-2">
                <input type="text" class="food w-full p-2 border border-gray-300 rounded-lg text-sm" placeholder="e.g., Chicken breast" />
                <input type="number" class="amount p-2 border border-gray-300 rounded-lg w-20 text-sm" placeholder="Amount" value="100" min="0.1" />
                <select class="unit p-2 border border-gray-300 rounded-lg text-sm w-20">
                    <option value="g">g</option>
                    <option value="mg">mg</option>
                    <option value="oz">oz</option>
                    <option value="cup">cup</option>
                    <option value="tbsp">tbsp</option>
                    <option value="tsp">tsp</option>
                    <option value="piece">pc</option>
                </select>
                <button class="bg-red-500 text-white rounded-lg p-2 text-sm hover:bg-red-600 w-10 flex-shrink-0" onclick="this.parentElement.remove()">✕</button>
            </div>`;
        }

        function addIngredient() {
            document.getElementById('ingredientsContainer').insertAdjacentHTML('beforeend', ingredientRowHTML());
        }

        // --- API CALL ---
        async function getNutrition(query) {
            try {
                // Call the secure Vercel proxy endpoint
                const res = await fetch(`/api/nutrition?query=${encodeURIComponent(query)}`);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return await res.json();
            } catch (error) {
                console.error("Error fetching nutrition data from API proxy:", error);
                return { items: [] }; // Return empty data on failure
            }
        }

        let macroChartInstance = null;

        // --- MAIN CALCULATION ---
        async function calculateRecipe() {
            const rows = document.querySelectorAll('.ingredient-row');
            let totals = { cal: 0, fat: 0, carb: 0, protein: 0, sodium: 0, fiber: 0, sugar: 0 };
            let successfulLookups = 0;

            // Simple loading indicator on the button
            const calcBtn = document.querySelector('.calc-btn');
            calcBtn.textContent = 'Calculating...';
            calcBtn.disabled = true;

            for (const row of rows) {
                const food = row.querySelector('.food').value.trim();
                const amt = row.querySelector('.amount').value;
                const unit = row.querySelector('.unit').value;
                
                if (!food || amt <= 0) continue;
                
                // CalorieNinja handles the quantity and unit in the query string
                const query = `${amt}${unit} ${food}`;
                const data = await getNutrition(query);

                if (data.items && data.items.length) {
                    const item = data.items[0];
                    // CalorieNinja uses a single item array for a single query
                    totals.cal += item.calories || 0;
                    totals.fat += item.fat_total_g || 0;
                    totals.carb += item.carbohydrates_total_g || 0;
                    totals.protein += item.protein_g || 0;
                    // Assuming CalorieNinja API returns these fields (common for full nutrition APIs)
                    totals.sodium += item.sodium_mg || 0;
                    totals.fiber += item.fiber_g || 0;
                    totals.sugar += item.sugar_g || 0; 
                    successfulLookups++;
                } else {
                    console.warn(`Could not find nutrition data for: ${query}`);
                }
            }
            
            calcBtn.textContent = 'Calculate Nutrition';
            calcBtn.disabled = false;
            
            if (successfulLookups === 0) {
                document.getElementById('resultsCard').style.display = 'none';
                alert("No ingredients were successfully analyzed. Please check your spelling.");
                return;
            }

            document.getElementById('resultsCard').style.display = 'block';
            updateNutritionTable(totals);
            updateMacroChart(totals);
        }

        // --- UPDATE TABLE ---
        function updateNutritionTable(totals) {
            const tableBody = document.getElementById('nutritionTable');

            // Helper to format values
            const formatG = (val) => `${val.toFixed(1)} g`;
            const formatMG = (val) => `${Math.round(val)} mg`;
            const formatCal = (val) => `${Math.round(val)}`;

            // Build the Nutrition Facts table rows
            tableBody.innerHTML = `
                <div class="line thick font-bold text-base">
                    Calories <span>${formatCal(totals.cal)}</span>
                </div>
                <div class="line thick font-bold text-base">
                    Total Fat <span>${formatG(totals.fat)}</span>
                </div>
                <div class="line">
                    Saturated Fat <span>0 g</span>
                </div>
                <div class="line thick font-bold text-base">
                    Sodium <span>${formatMG(totals.sodium)}</span>
                </div>
                <div class="line thick font-bold text-base">
                    Total Carbohydrate <span>${formatG(totals.carb)}</span>
                </div>
                <div class="line indent">
                    Dietary Fiber <span>${formatG(totals.fiber)}</span>
                </div>
                <div class="line indent">
                    Total Sugars <span>${formatG(totals.sugar)}</span>
                </div>
                <div class="line thick font-bold text-base no-border">
                    Protein <span>${formatG(totals.protein)}</span>
                </div>
            `;
        }

        // --- UPDATE CHART ---
        function updateMacroChart(totals) {
            const ctx = document.getElementById("macroChart").getContext("2d");
            if (macroChartInstance) macroChartInstance.destroy();

            const macroData = [totals.fat, totals.carb, totals.protein];
            const totalMacros = totals.fat + totals.carb + totals.protein;

            // Pastel Colors
            const pastelColors = ["#FFC3A0", "#C6E2FF", "#D7FFC6"]; 

            macroChartInstance = new Chart(ctx, {
                type: "doughnut", // Changed to Donut style
                data: {
                    labels: ["Fat (g)", "Carbs (g)", "Protein (g)"],
                    datasets: [{
                        data: macroData,
                        backgroundColor: pastelColors,
                        hoverOffset: 15,
                        borderWidth: 2,
                        borderColor: '#ffffff',
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                // Add percentage to legend labels
                                generateLabels: (chart) => {
                                    const data = chart.data;
                                    if (data.labels.length && data.datasets.length) {
                                        return data.labels.map((label, i) => {
                                            const value = data.datasets[0].data[i];
                                            const percentage = totalMacros > 0 ? ((value / totalMacros) * 100).toFixed(1) : 0;
                                            return {
                                                text: `${label}: ${value.toFixed(1)}g (${percentage}%)`, // Display name, value, and percentage
                                                fillStyle: data.datasets[0].backgroundColor[i],
                                                strokeStyle: data.datasets[0].borderColor,
                                                lineWidth: data.datasets[0].borderWidth,
                                                hidden: isNaN(value),
                                                index: i
                                            };
                                        });
                                    }
                                    return [];
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Macronutrient Split (by weight in grams)',
                            font: { size: 14, weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                    return `${label}: ${value.toFixed(1)}g (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- UTILITIES ---
        function copyTable() { 
            const tableText = "Nutrition Facts\n" + document.getElementById("nutritionTable").innerText;
            navigator.clipboard.writeText(tableText)
                .then(() => alert("Nutrition facts copied to clipboard!"))
                .catch(err => console.error('Could not copy text: ', err));
        }

        async function shareTable() { 
            const tableText = "Check out my recipe nutrition facts from NutriFind:\n" + document.getElementById("nutritionTable").innerText;
            if (navigator.share) { 
                await navigator.share({ 
                    title: 'NutriFind Recipe Facts', 
                    text: tableText 
                }); 
            } else { 
                alert("Sharing not supported on this browser. Use the Copy button instead."); 
            }
        }
    </script>
</body>
</html>
